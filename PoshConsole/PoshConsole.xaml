<Window
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:huddle="http://schemas.huddledmasses.org/wpf/controls"

    xmlns:PoshControls="clr-namespace:PoshConsole.Controls"
    xmlns:hotkeys="http://schemas.huddledmasses.org/interop/hotkeys"
    xmlns:Properties="clr-namespace:PoshConsole.Properties"
    x:Class="PoshConsole.PoshConsoleWindow" x:Name="window"
    Title="{Binding Path=Title, ElementName=buffer, Mode=Default}"
    Visibility="Visible" Background="Transparent" AllowsTransparency="False"
    BorderThickness="0"
    ResizeMode="CanResizeWithGrip"
    SnapsToDevicePixels="True"

    SourceInitialized="OnWindowSourceInitialized"
    Loaded="OnWindowLoaded"
    Closing="OnWindowClosing"
    Activated="OnWindowActivated"
    Deactivated="OnWindowDeactivated"
    LocationChanged="OnWindowLocationChanged"
    SizeChanged="OnWindowSizeChanged"
    Icon="pack://application:,,,/Artwork/PoshConsoleWindow.ico"
    
    hotkeys:HotkeyManager.HotkeyManager="{DynamicResource hotkeys}"
    Width="532" Height="375" xmlns:d="http://schemas.microsoft.com/expression/blend/2008" mc:Ignorable="d"
    ><!--
    ShowInTaskbar="{Binding Path=ShowInTaskbar, Source={StaticResource SettingsDS}, Mode=Default}"
    Opacity="{Binding Path=Opacity, Mode=Default, Source={StaticResource SettingsDS}}"
    Left="{Binding Path=WindowLeft, Mode=Default, Source={StaticResource SettingsDS}}"
    Top="{Binding Path=WindowTop, Mode=Default, Source={StaticResource SettingsDS}}"
    Topmost="{Binding Path=AlwaysOnTop, Mode=Default, Source={StaticResource SettingsDS}}"
    -->
    <Window.Resources>
        <hotkeys:HotkeyManager x:Key="hotkeys">
            <KeyBinding Command="hotkeys:GlobalCommands.ActivateWindow" Key="C"  Modifiers="Win" />
            <KeyBinding Command="hotkeys:GlobalCommands.CloseWindow"    Key="F4" Modifiers="Win" />
            <KeyBinding Command="hotkeys:GlobalCommands.HideWindow"     Key="S"  Modifiers="Win+Shift" />
            <KeyBinding Command="hotkeys:GlobalCommands.ShowWindow"     Key="S"  Modifiers="Win" />
        </hotkeys:HotkeyManager>

        <!--<PoshProps:Settings x:Key="SettingsDS" />-->
      <ObjectDataProvider x:Key="SettingsDS" d:IsDataSource="True" ObjectType="{x:Type Properties:Settings}"/>
      <ObjectDataProvider x:Key="ColorsDS" d:IsDataSource="True" ObjectType="{x:Type Properties:Colors}"/>
       
      <Style x:Key="{x:Type ResizeGrip}" TargetType="{x:Type ResizeGrip}">
         <Setter Property="MinWidth" Value="{DynamicResource {x:Static SystemParameters.VerticalScrollBarWidthKey}}"/>
         <Setter Property="MinHeight" Value="{DynamicResource {x:Static SystemParameters.HorizontalScrollBarHeightKey}}"/>
         <Setter Property="Background" Value="Transparent"/>
         <Setter Property="Template">
            <Setter.Value>
               <ControlTemplate TargetType="{x:Type ResizeGrip}">
                  <Grid SnapsToDevicePixels="True" Background="Transparent">
                     <Path Fill="#66FFFFFF" HorizontalAlignment="Right" Margin="0,0,2,2" VerticalAlignment="Bottom"
                              Data="M 8,0 L 10,0 L 10,2 L 8,2 Z M 4,4 L 6,4 L 6,6 L 4,6 Z M 8,4 L 10,4 L 10,6 L 8,6 Z M 0,8 L 2,8 L 2,10 L 0,10 Z M 4,8 L 6,8 L 6,10 L 4,10 Z M 8,8 L 10,8 L 10,10 L 8,10 Z"/>
                     <Path Fill="{Binding Path=BorderColorBottomRight, Mode=Default, Source={StaticResource SettingsDS}}"
                              HorizontalAlignment="Right" Margin="0,0,5,5" VerticalAlignment="Bottom"
                              Data="M 8,0 L 10,0 L 10,2 L 8,2 Z M 4,4 L 6,4 L 6,6 L 4,6 Z M 8,4 L 10,4 L 10,6 L 8,6 Z M 0,8 L 2,8 L 2,10 L 0,10 Z M 4,8 L 6,8 L 6,10 L 4,10 Z M 8,8 L 10,8 L 10,10 L 8,10 Z"/>
                  </Grid>
               </ControlTemplate>
            </Setter.Value>
         </Setter>
      </Style>
      <Style BasedOn="{x:Null}" TargetType="{x:Type TextBox}">
         <!-- It turns out that setting this Background is the main way to change the cursor color too!
            http://blogs.msdn.com/llobo/archive/2007/02/08/changing-caret-color-in-textbox.aspx
            -->
         <Setter Property="Foreground" Value="{Binding Path=Foreground, ElementName=buffer}" />
         <Setter Property="Background">
            <Setter.Value>
               <Binding Path="CaretColor" ElementName="buffer">
                  <Binding.Converter>
                     <huddle:ColorToBrushInverter Alpha="255" />
                  </Binding.Converter>
               </Binding>
            </Setter.Value>
         </Setter>
         <Setter Property="Padding" Value="1"/>
         <Setter Property="AllowDrop" Value="true"/>
         <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
         <Setter Property="Template">
            <Setter.Value>
               <ControlTemplate TargetType="{x:Type TextBox}">
                  <!-- The textbox insertion caret color is the inverse of it's background color. 
                  In order to give ourselves control over it, separate from changing the actual background color ...
                  We use a template with a Border that has it's own background color which can be set manually.
                  -->
                  <!-- ABOUT TextBoxBase templates.  The control template for a TextBox or RichTextBox must include 
                     an element tagged as the content host, that is, with the Name="PART_ContentHost".  
                     Despite assurances about template iindependence, the content host element *must* be 
                     a ScrollViewer, or an element that derives from Decorator. 
                  -->
                  <!--<aero:ListBoxChrome xmlns:aero="clr-namespace:Microsoft.Windows.Themes;assembly=PresentationFramework.Aero"
                                    SnapsToDevicePixels="true" x:Name="Bd"
                                    Background="#FF000000"
                                    BorderThickness="20"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    RenderFocused="{TemplateBinding IsKeyboardFocusWithin}"
                                    RenderMouseOver="{TemplateBinding IsMouseOver}">-->
                     <Border x:Name="Border" 
                            BorderThickness="0"
                            Background="{Binding Path=Background, ElementName=buffer}" 
                            SnapsToDevicePixels="True"
                            Padding="2">
                        <ScrollViewer x:Name="PART_ContentHost"
                                      SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" 
                                      Padding="0,0,0,0" />
                     </Border>
                  <!--</aero:ListBoxChrome>-->
               </ControlTemplate>
            </Setter.Value>
         </Setter>
      </Style>
      <Style TargetType="{x:Type FlowDocument}">
         <Setter Property="OverridesDefaultStyle" Value="true"/>
      </Style>
      <Style TargetType="{x:Type huddle:ConsoleControl}">
         <Setter Property="MinWidth" Value="250"/>
      </Style>
     <Style x:Key="WindowBorder" TargetType="{x:Type Border}">
         <Setter Property="BorderBrush">
             <Setter.Value>
                 <LinearGradientBrush StartPoint="0,0" EndPoint=".5,1" SpreadMethod="Pad">
                     <GradientStop Offset="0" Color="{Binding Path=BorderColorTopLeft, Mode=Default, Source={StaticResource SettingsDS}}"/>
                     <GradientStop Offset="0.803" Color="{Binding Path=BorderColorBottomRight, Mode=Default, Source={StaticResource SettingsDS}}"/>
                 </LinearGradientBrush>
             </Setter.Value>
         </Setter>
         <Setter Property="BorderThickness" Value="{Binding Path=BorderThickness, Mode=Default, Source={StaticResource SettingsDS}}"/>
     </Style>
    </Window.Resources>
    <!--
    xmlns:PoshControls="http://schemas.poshconsole.org/controls"
    xmlns:PoshInterop="http://schemas.poshconsole.org/interop"
    xmlns:Properties="http://schemas.poshconsole.org/properties"
    -->
    <Window.CommandBindings>
        <CommandBinding Command="ApplicationCommands.Stop" Executed="OnHandleControlC" CanExecute="OnCanHandleControlC"/>
        <!--<CommandBinding Command="ApplicationCommands.Copy" Executed="HandleControlC" CanExecute="CanHandleControlC"/>-->

        <!--<CommandBinding Command="ApplicationCommands.ContextMenu" Executed="ContextMenu" />-->
        <CommandBinding Command="NavigationCommands.Zoom" Executed="OnHandleSetZoom" />
        <CommandBinding Command="NavigationCommands.IncreaseZoom" Executed="OnHandleIncreaseZoom" />
        <CommandBinding Command="NavigationCommands.DecreaseZoom" Executed="OnHandleDecreaseZoom" />
    </Window.CommandBindings>
    <Window.InputBindings>
        <!-- 
        <KeyBinding Command="ApplicationCommands.ContextMenu" Key="F7" Modifiers="Control" />
        -->

        <!-- Default Binding 
        -->
        <KeyBinding Command="ApplicationCommands.Stop" Key="Escape" />
        <KeyBinding Command="ApplicationCommands.Stop" Key="F2" />
        <KeyBinding Command="ApplicationCommands.Stop" Key="Pause" Modifiers="Control" />
        <KeyBinding Command="ApplicationCommands.Stop" Key="C" Modifiers="Control" />
        <!--<KeyBinding Command="ApplicationCommands.Copy" Key="C" Modifiers="Control" />-->

        <KeyBinding Command="NavigationCommands.IncreaseZoom" Key="OemPlus" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.IncreaseZoom" Key="Add" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.DecreaseZoom" Key="Subtract" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.DecreaseZoom" Key="OemMinus" Modifiers="Control" />

        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="1.0" Key="D0" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="1.1" Key="D1" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="1.2" Key="D2" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="1.3" Key="D3" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="1.4" Key="D4" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="1.5" Key="D5" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="0.6" Key="D6" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="0.7" Key="D7" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="0.8" Key="D8" Modifiers="Control" />
        <KeyBinding Command="NavigationCommands.Zoom" CommandParameter="0.9" Key="D9" Modifiers="Control" />


    </Window.InputBindings>
    <Window.ShowInTaskbar>
        <Binding Path="ShowInTaskbar" Mode="Default" Source="{StaticResource SettingsDS}"/>
    </Window.ShowInTaskbar>
    <Window.Opacity>
        <Binding Path="Opacity" Mode="Default" Source="{StaticResource SettingsDS}"/>
    </Window.Opacity>
    <Window.Left>
        <Binding Path="WindowLeft" Mode="Default" Source="{StaticResource SettingsDS}"/>
    </Window.Left>
    <Window.Top>
        <Binding Path="WindowTop" Mode="Default" Source="{StaticResource SettingsDS}"/>
    </Window.Top>
    <Window.Topmost>
        <Binding Path="AlwaysOnTop" Mode="Default" Source="{StaticResource SettingsDS}"/>
    </Window.Topmost>
    <Border x:Name="border" CornerRadius="5" Style="{DynamicResource WindowBorder}" Visibility="Visible" BorderThickness="{Binding Path=BorderThickness, Mode=Default, Source={StaticResource SettingsDS}}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" MaxHeight="300" MinHeight="0"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto" MaxHeight="22" MinHeight="0"/>
            </Grid.RowDefinitions>
            <PoshControls:ProgressPanel x:Name="progress"
               Grid.Row="1" Visibility="Collapsed" Width="Auto" d:LayoutOverrides="GridBox" Margin="0,0,-168,0" />
        	<huddle:ConsoleControl Grid.Row="1" x:Name="buffer"
        		HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
        		ForceCursor="True"
        		BackgroundColor="Black" Background="Black"
        		ForegroundColor="White" Foreground="White"
            CaretColor="Cyan"
        		PreviewMouseWheel="OnBufferPreviewMouseWheel"
        		Padding="0" Margin="0" BorderThickness="0"
        		Title="PoshConsole"
                                        
                                        >
        		<!--FontFamily="/FontLibrary;Component/#Bitstream Vera Sans Mono"-->
        		<huddle:ConsoleControl.Resources>
        			<Style TargetType="{x:Type Paragraph}">
        				<Setter Property="Margin" Value="0"/>
        			</Style>
        		</huddle:ConsoleControl.Resources>
        		<huddle:ConsoleControl.FontSize>
        			<Binding Path="FontSize" Mode="OneWay" Source="{StaticResource SettingsDS}"/>
        		</huddle:ConsoleControl.FontSize>
        		<!--FontFamily="/FontLibrary;Component/#Bitstream Vera Sans Mono"-->
        		<huddle:ConsoleControl.FontFamily>
        			<Binding Path="FontFamily" Mode="OneWay" Source="{StaticResource SettingsDS}"/>
        		</huddle:ConsoleControl.FontFamily>
        		<huddle:ConsoleControl.ContextMenu>
        			<ContextMenu/>
        		</huddle:ConsoleControl.ContextMenu>
        		<FlowDocument>
        			<FlowDocument.Resources>
        				<!-- NOTE: these Resources are EXPOSED TO BANNERS so be careful what you put here -->
        				<Style x:Key="POSHFont">
        					<Setter Property="TextElement.FontFamily" Value="/FontLibrary;Component/#QUAKE" />
        				</Style>
        				<Style x:Key="ConsoleFont">
        					<Setter Property="TextElement.FontSize" Value="12" />
        					<Setter Property="TextElement.FontFamily" Value="/FontLibrary;Component/#Bitstream Vera Sans Mono" />
        				</Style>
        				<Style x:Key="BannerFont">
        					<Setter Property="TextElement.FontSize" Value="20" />
        					<Setter Property="TextElement.FontFamily" Value="/FontLibrary;Component/#Pescadero" />
        					<Setter Property="Typography.ContextualSwashes" Value="1" />
        				</Style>
        				<Style x:Key="SigFont">
        					<Setter Property="TextElement.FontSize" Value="20" />
        					<Setter Property="TextElement.FontFamily" Value="/FontLibrary;Component/#Lindsey" />
        					<Setter Property="Typography.ContextualSwashes" Value="1" />
        				</Style>
        			</FlowDocument.Resources>
        			<Paragraph ClearFloaters="Both" />
        		</FlowDocument>

        	</huddle:ConsoleControl>
        	<StatusBar Grid.Row="2" Padding="0,2,0,0" x:Name="status" OpacityMask="#FE000000"
        		Background="{Binding Path=Background, ElementName=buffer, Mode=Default}"
        		Foreground="{Binding Path=Foreground, ElementName=buffer, Mode=Default}"
            BorderBrush="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"  BorderThickness="0,1,0,0"
        		HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch"
            VerticalContentAlignment="Stretch" VerticalAlignment="Top" Height="23.65" >
        		<!--<StatusBar.BitmapEffect>
        			<BevelBitmapEffect BevelWidth="2" EdgeProfile="CurvedIn" Relief="0.17" Smoothness="0.5"/>
        		</StatusBar.BitmapEffect>-->
        		<StatusBarItem x:Name="title" Padding="4,0,4,0" DockPanel.Dock="Left" Content="{Binding Path=Title, ElementName=buffer, Mode=Default}" >
        			<StatusBarItem.BitmapEffect>
        				<DropShadowBitmapEffect/>
        			</StatusBarItem.BitmapEffect>
        		</StatusBarItem>

        		<Separator DockPanel.Dock="Left" />

        		<StatusBarItem x:Name="admin" Padding="4,0,4,0" DockPanel.Dock="Right" HorizontalContentAlignment="Right" Content="Normal" Cursor="Hand" ToolTip="Double Click to re-start as administrator" FontWeight="Bold" Foreground="#FF11CC11" MouseDoubleClick="OnAdminMouseDoubleClick" >
        			<StatusBarItem.BitmapEffect>
        				<DropShadowBitmapEffect/>
        			</StatusBarItem.BitmapEffect>
        		</StatusBarItem>

        		<Separator DockPanel.Dock="Right" />

        		<!-- Last item is docked in center, as usual. -->
        		<StatusBarItem HorizontalAlignment="Center" HorizontalContentAlignment="Center" Content="" Width="Auto" x:Name="statusMiddle" >
        			<StatusBarItem.BitmapEffect>
        				<DropShadowBitmapEffect/>
        			</StatusBarItem.BitmapEffect>
        		</StatusBarItem>
        	</StatusBar>
        </Grid>
    </Border>
</Window>
